version: '2.1'

networks:
  vpn-vlan:
    name: vpn-vlan

services:
  haproxy:
    build:
      context: .
      dockerfile: haproxy.dockerfile
    networks:
      - vpn-vlan
    ports:
      - "${PROXY_PORT:-8888}:5000"
      - "${STATS_PORT:-8887}:1936"
    restart: always
    depends_on:
      - vpn-proxy
    environment:
      FRONTEND_PORT: 5000
      FRONTEND_MODE: "http"
      BACKENDS: "vpn-proxy"
      BACKENDS_PORT: 8118
      BACKENDS_MODE: "http"
      DNS_ENABLED: "True"
      PROXY_PROTOCOL_ENABLED: "True"
      BALANCE: "roundrobin"
      LOG_LEVEL: "debug"

  vpn-proxy:
#   image: solardesigner/vpn-proxy:latest
    build:
      context: .
      dockerfile: vpn-proxy.dockerfile
    container_name: vpn-proxy # Use docker-compose up --scale vpn-proxy=3
    cap_add:
      - NET_ADMIN
    dns:
      - "${DNS_SERVER_1:-9.9.9.9}"
      - "${DNS_SERVER_2:-1.1.1.1}"
    environment:
      OPENVPN_USERNAME: "${OPENVPN_USERNAME}"
      OPENVPN_PASSWORD: "${OPENVPN_PASSWORD}"
      OPENVPN_PROVIDER: "${OPENVPN_PROVIDER:-nordvpn}"
      OPENVPN_FILE:     "${OPENVPN_FILE:-ca120.nordvpn.com.tcp.ovpn}"
      LOCAL_NETWORK:    "${LOCAL_NETWORK:-192.168.1.0/24}"
    expose:
      - 8118
    networks:
      - vpn-vlan
    restart: always